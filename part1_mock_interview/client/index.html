<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Mock Interview • LiveKit Voice Demo</title>

  <!-- LiveKit Client Library (pinned) with CDN fallback -->
  <script>
    const script1 = document.createElement('script');
    script1.src = 'https://unpkg.com/livekit-client@2.5.4/dist/livekit-client.umd.js';
    script1.onload = () => console.log('✓ LiveKit loaded from unpkg');
    script1.onerror = () => {
      console.error('✗ Failed to load from unpkg, trying jsDelivr...');
      const script2 = document.createElement('script');
      script2.src = 'https://cdn.jsdelivr.net/npm/livekit-client@2.5.4/dist/livekit-client.umd.js';
      script2.onload = () => console.log('✓ LiveKit loaded from jsDelivr');
      script2.onerror = () => console.error('✗ Failed to load LiveKit from both CDNs');
      document.head.appendChild(script2);
    };
    document.head.appendChild(script1);
  </script>

  <style>
    :root{
      --bg0:#07070c;
      --bg1:#0b0b16;
      --card: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.10);
      --text:#f5f5ff;
      --muted: rgba(245,245,255,.65);
      --muted2: rgba(245,245,255,.45);
      --accent:#a855f7;
      --accent2:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;
      --shadow: 0 20px 60px rgba(0,0,0,.55);
      --shadow2: 0 12px 30px rgba(0,0,0,.45);
      --radius2: 22px;
      --glass: blur(16px);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; margin:0; padding:0; }
    html,body{ height:100%; }
    body{
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(168,85,247,.18), transparent 60%),
        radial-gradient(900px 500px at 85% 25%, rgba(59,130,246,.16), transparent 60%),
        radial-gradient(900px 600px at 50% 100%, rgba(34,197,94,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .bg-grid{
      position:fixed; inset:0; pointer-events:none; opacity:.16;
      background-image:
        linear-gradient(to right, rgba(255,255,255,.08) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(255,255,255,.08) 1px, transparent 1px);
      background-size: 48px 48px;
      mask-image: radial-gradient(circle at 50% 20%, black 0 40%, transparent 75%);
    }

    .wrap{ min-height:100%; display:flex; flex-direction:column; }

    header{
      position:sticky; top:0; z-index:50;
      backdrop-filter: var(--glass);
      -webkit-backdrop-filter: var(--glass);
      background: rgba(10,10,20,.45);
      border-bottom: 1px solid var(--border);
    }
    .header-inner{
      max-width: 1240px; margin: 0 auto;
      padding: 18px 20px;
      display:flex; align-items:center; justify-content:space-between; gap:16px;
    }
    .brand{ display:flex; align-items:center; gap:14px; }
    .logo{
      width:38px; height:38px; border-radius: 12px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), transparent 55%),
        linear-gradient(135deg, rgba(168,85,247,.95), rgba(59,130,246,.85));
      box-shadow: 0 12px 30px rgba(168,85,247,.18);
      position:relative; overflow:hidden;
    }
    .logo:after{
      content:""; position:absolute; inset:-40%;
      background: radial-gradient(circle, rgba(255,255,255,.25), transparent 55%);
      animation: floatGlow 7s ease-in-out infinite;
    }
    @keyframes floatGlow{
      0%,100%{ transform: translate(-6%, -6%) rotate(0deg); opacity:.85; }
      50%{ transform: translate(6%, 4%) rotate(18deg); opacity:.55; }
    }
    .title{ display:flex; flex-direction:column; line-height:1.1; }
    .title h1{ font-size: 16px; font-weight: 700; letter-spacing:.2px; }
    .title p{ display:none; } /* removed tagline as requested */

    .chips{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px; border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--muted); font-size: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,.15);
    }
    .dot{ width:9px; height:9px; border-radius:999px; background: rgba(245,245,255,.4); box-shadow: 0 0 0 rgba(245,245,255,.0); }
    .dot.connected{ background: var(--accent2); box-shadow: 0 0 14px rgba(34,197,94,.55); }
    .dot.connecting{ background: var(--warn); box-shadow: 0 0 14px rgba(245,158,11,.55); }
    .dot.disconnected{ background: var(--danger); box-shadow: 0 0 14px rgba(239,68,68,.45); }

    main{
      flex:1;
      max-width: 1240px; width:100%;
      margin: 0 auto;
      padding: 22px 20px 26px;
      display:grid;
      grid-template-columns: 1.45fr .75fr;
      gap: 18px;
    }
    @media (max-width: 1020px){
      main{ grid-template-columns: 1fr; }
      .chips{ justify-content:flex-start; }
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius2);
      box-shadow: var(--shadow2);
      position:relative;
      overflow:hidden;
    }
    .card:before{
      content:"";
      position:absolute; inset:-1px;
      background: radial-gradient(900px 240px at 20% 0%, rgba(168,85,247,.14), transparent 55%);
      pointer-events:none;
    }
    .card-inner{ position:relative; padding: 16px; }

    .card-title{
      display:flex; align-items:center; justify-content:space-between;
      gap: 10px; margin-bottom: 12px;
    }
    .card-title h2{
      font-size: 13px;
      font-weight: 800;
      letter-spacing: .5px;
      text-transform: uppercase;
      color: rgba(245,245,255,.88);
    }
    .badge{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(245,245,255,.7);
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.10);
    }

    .form{ display:grid; gap: 10px; }
    .field label{
      display:flex; align-items:center; justify-content:space-between;
      font-size: 12px; color: var(--muted);
      margin-bottom: 6px;
    }
    .field input{
      width:100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      color: var(--text);
      outline:none;
      transition: transform .18s ease, border-color .18s ease, box-shadow .18s ease;
    }
    .field input:focus{
      border-color: rgba(168,85,247,.55);
      box-shadow: 0 0 0 4px rgba(168,85,247,.15);
      transform: translateY(-1px);
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .btn{
      user-select:none;
      cursor:pointer;
      border:none;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing:.6px;
      font-size: 12px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      color: white;
      transition: transform .18s ease, box-shadow .18s ease, filter .18s ease, opacity .18s ease;
      box-shadow: 0 14px 34px rgba(0,0,0,.28);
    }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn:disabled{ opacity:.45; cursor:not-allowed; box-shadow:none; }
    .btn-primary{ background: linear-gradient(135deg, rgba(168,85,247,.95), rgba(59,130,246,.86)); }
    .btn-danger{ background: linear-gradient(135deg, rgba(239,68,68,.95), rgba(127,29,29,.85)); }
    .btn-ghost{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(245,245,255,.85);
      box-shadow:none;
    }
    .btn:hover:not(:disabled){
      transform: translateY(-1px);
      filter: brightness(1.06);
      box-shadow: 0 18px 44px rgba(0,0,0,.33);
    }

    .conversation{ min-height: 520px; display:flex; flex-direction:column; gap: 12px; }

    .messages{
      flex:1; overflow:auto; padding: 12px;
      border-radius: 16px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.08);
    }

    .msg{
      border-radius: 14px;
      padding: 10px 12px;
      margin: 10px 0;
      border: 1px solid rgba(255,255,255,.10);
      animation: msgIn .28s ease both;
    }
    @keyframes msgIn{ from{ opacity:0; transform: translateY(10px); } to{ opacity:1; transform: translateY(0); } }
    .msg.system{ background: rgba(59,130,246,.10); border-color: rgba(59,130,246,.22); color: rgba(245,245,255,.82); }
    .msg-head{ display:flex; justify-content:space-between; align-items:center; font-size: 11px; color: var(--muted2); margin-bottom: 6px; }
    .msg-body{ font-size: 13px; line-height: 1.55; color: rgba(245,245,255,.92); }

    .stack{ display:flex; flex-direction:column; gap: 14px; }

    .status-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .stat{
      padding: 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
    }
    .stat .k{ font-size: 11px; color: var(--muted2); margin-bottom: 6px; letter-spacing: .2px; }
    .stat .v{ font-size: 13px; font-weight: 800; color: rgba(245,245,255,.9); }

    .voice-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 520px){ .voice-grid{ grid-template-columns: 1fr; } }

    .speaker-tile{
      border-radius: 18px;
      padding: 14px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
      position:relative;
      overflow:hidden;
      --lvl: 0;
    }
    .speaker-top{
      position:relative;
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom: 12px;
    }
    .speaker-top .name{ font-weight: 900; letter-spacing:.2px; font-size: 13px; }
    .speaker-top .hint{
      font-family: var(--mono);
      font-size: 11px;
      color: var(--muted);
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
    }

    .avatar{
      position:relative;
      width: 120px; height: 120px;
      margin: 0 auto;
      display:grid; place-items:center;
      --level: 0;
    }
    .ring{
      position:absolute;
      inset: 0;
      border-radius: 999px;
      background:
        radial-gradient(circle at 35% 25%, rgba(255,255,255,.18), transparent 55%),
        radial-gradient(circle at 70% 75%, rgba(255,255,255,.10), transparent 55%),
        linear-gradient(135deg, rgba(168,85,247,.65), rgba(59,130,246,.55));
      opacity: .95;
      transform: scale(calc(0.98 + var(--level) * 0.08));
      transition: transform .08s linear, opacity .08s linear;
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
    }
    .speaker-tile.ai .ring{
      background:
        radial-gradient(circle at 35% 25%, rgba(255,255,255,.14), transparent 55%),
        radial-gradient(circle at 70% 75%, rgba(255,255,255,.08), transparent 55%),
        linear-gradient(135deg, rgba(34,197,94,.60), rgba(59,130,246,.55));
    }

    .core{
      position:absolute;
      inset: 14px;
      border-radius: 999px;
      background: rgba(8,8,16,.70);
      border: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(10px);
      display:grid;
      place-items:center;
      overflow:hidden;
    }
    .core:before{
      content:"";
      position:absolute; inset:-30%;
      background: radial-gradient(circle, rgba(255,255,255,.10), transparent 58%);
      opacity: calc(0.35 + var(--level) * 0.45);
      transform: translate(calc(var(--level) * 10px), calc(var(--level) * -8px)) rotate(calc(var(--level) * 20deg));
      transition: opacity .10s linear, transform .10s linear;
    }

    .wave{
      position:absolute;
      inset:-10px;
      border-radius:999px;
      border: 2px solid rgba(168,85,247,.0);
      opacity: 0;
      transform: scale(0.90);
      pointer-events:none;
    }
    .speaker-tile.speaking .wave{
      animation: wavePulse 1.4s ease-in-out infinite;
      border-color: rgba(168,85,247, calc(0.18 + var(--level) * 0.60));
      opacity: 1;
    }
    .speaker-tile.ai.speaking .wave{
      border-color: rgba(34,197,94, calc(0.18 + var(--level) * 0.60));
    }
    .wave.wave2{ inset:-22px; animation-delay: .18s; }
    .wave.wave3{ inset:-36px; animation-delay: .34s; }
    @keyframes wavePulse{
      0%{ transform: scale(0.88); opacity: .00; }
      25%{ opacity: .95; }
      100%{ transform: scale(1.10); opacity: 0; }
    }

    .eq{
      position:relative;
      display:flex;
      gap: 4px;
      align-items:flex-end;
      height: 44px;
      z-index:2;
    }
    .bar{
      width: 6px;
      border-radius: 999px;
      background: rgba(245,245,255,.75);
      height: 10px;
      transform-origin: bottom;
      opacity: .90;
    }
    .speaker-tile .bar{
      height: calc(10px + var(--lvl) * 34px);
      animation: barBounce 1.0s ease-in-out infinite;
      animation-play-state: paused;
    }
    .speaker-tile.speaking .bar{ animation-play-state: running; }
    .speaker-tile .bar:nth-child(1){ animation-delay: .00s; opacity:.70; }
    .speaker-tile .bar:nth-child(2){ animation-delay: .08s; opacity:.85; }
    .speaker-tile .bar:nth-child(3){ animation-delay: .16s; opacity:.95; }
    .speaker-tile .bar:nth-child(4){ animation-delay: .24s; opacity:.85; }
    .speaker-tile .bar:nth-child(5){ animation-delay: .32s; opacity:.70; }
    @keyframes barBounce{
      0%,100%{ transform: scaleY(calc(0.55 + var(--lvl) * 0.80)); }
      50%{ transform: scaleY(calc(1.20 + var(--lvl) * 1.00)); }
    }

    .speaker-foot{
      position:relative;
      margin-top: 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size: 12px;
      color: var(--muted);
    }
    .meter{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(245,245,255,.75);
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
    }

    .stage-pill{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding: 12px 12px;
      border-radius: 16px;
      background: rgba(168,85,247,.10);
      border: 1px solid rgba(168,85,247,.22);
    }
    .stage-pill .k{
      font-size: 11px;
      color: rgba(245,245,255,.75);
      text-transform: uppercase;
      letter-spacing:.5px;
      font-weight: 900;
    }
    .stage-pill .v{
      font-size: 13px;
      font-weight: 900;
      color: rgba(245,245,255,.92);
    }

    .toasts{
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 9999;
      display:flex;
      flex-direction:column;
      gap: 10px;
      pointer-events:none;
    }
    .toast{
      pointer-events:auto;
      width: min(420px, calc(100vw - 40px));
      border-radius: 16px;
      padding: 12px 12px;
      background: rgba(0,0,0,.55);
      border: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow);
      animation: toastIn .22s ease both;
    }
    @keyframes toastIn{ from{ opacity:0; transform: translateY(10px); } to{ opacity:1; transform: translateY(0); } }
    .toast .top{ display:flex; justify-content:space-between; align-items:flex-start; gap: 12px; }
    .toast .t{ font-weight: 900; font-size: 12px; letter-spacing:.2px; margin-bottom: 4px; }
    .toast .m{ font-size: 12px; color: rgba(245,245,255,.78); line-height:1.45; }
    .toast .x{ cursor:pointer; border:none; background: transparent; color: rgba(245,245,255,.7); font-size: 18px; line-height: 1; padding: 0 4px; }
    .toast.error{ border-color: rgba(239,68,68,.35); }
    .toast.error .t{ color: rgba(252,165,165,.95); }
    .toast.info{ border-color: rgba(59,130,246,.30); }
    .toast.info .t{ color: rgba(147,197,253,.98); }
    .toast.ok{ border-color: rgba(34,197,94,.30); }
    .toast.ok .t{ color: rgba(134,239,172,.98); }

    .help{ color: var(--muted); font-size: 12px; line-height: 1.45; }
    .help strong{ color: rgba(245,245,255,.85); }
  </style>
</head>

<body>
  <div class="bg-grid"></div>
  <div class="wrap">
    <header>
      <div class="header-inner">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div class="title">
            <h1>AI Mock Interview • LiveKit Voice Demo</h1>
            <p>hidden</p>
          </div>
        </div>

        <div class="chips">
          <div class="chip">
            <span class="dot disconnected" id="hdrConnDot"></span>
            <span id="hdrConnText">Disconnected</span>
          </div>
          <div class="chip">
            <span class="dot" id="hdrSdkDot"></span>
            <span id="sdkStatus">Checking SDK…</span>
          </div>
          <button class="btn btn-ghost" style="padding:10px 12px; font-size:12px;" onclick="checkSDKStatus()">
            Check SDK
          </button>
        </div>
      </div>
    </header>

    <main>
      <section class="card">
        <div class="card-inner conversation">
          <div class="card-title">
            <h2>Conversation</h2>
            <span class="badge" id="connectionStatusText">Disconnected</span>
          </div>

          <div class="voice-grid">
            <div class="speaker-tile user" id="userTile">
              <div class="speaker-top">
                <div class="name">You</div>
                <div class="hint" id="micStatus">Not enabled</div>
              </div>
              <div class="avatar" id="userAvatar" style="--level:0;">
                <div class="wave wave1"></div>
                <div class="wave wave2"></div>
                <div class="wave wave3"></div>
                <div class="ring"></div>
                <div class="core">
                  <div class="eq" aria-hidden="true">
                    <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
                  </div>
                </div>
              </div>
              <div class="speaker-foot">
                <span>Mic Activity</span>
                <span class="meter" id="userMeter">lvl 0.00</span>
              </div>
            </div>

            <div class="speaker-tile ai" id="aiTile">
              <div class="speaker-top">
                <div class="name">AI Interviewer</div>
                <div class="hint" id="speakerStatus">Not enabled</div>
              </div>
              <div class="avatar" id="aiAvatar" style="--level:0;">
                <div class="wave wave1"></div>
                <div class="wave wave2"></div>
                <div class="wave wave3"></div>
                <div class="ring"></div>
                <div class="core">
                  <div class="eq" aria-hidden="true">
                    <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
                  </div>
                </div>
              </div>
              <div class="speaker-foot">
                <span>AI Audio Activity</span>
                <span class="meter" id="aiMeter">lvl 0.00</span>
              </div>
            </div>
          </div>

          <div class="messages" id="messages">
            <div class="msg system">
              <div class="msg-head">
                <span><strong>System</strong></span>
                <span>—</span>
              </div>
              <div class="msg-body">
                Welcome! Connect to start your mock interview. This UI publishes your microphone to LiveKit and plays the AI interviewer’s audio.
              </div>
            </div>
          </div>
        </div>
      </section>

      <aside class="stack">
        <section class="card">
          <div class="card-inner">
            <div class="card-title">
              <h2>Connection</h2>
              <span class="badge" id="connectionBadge">Ready</span>
            </div>

            <div class="form">
              <div class="field">
                <label>
                  <span>LiveKit URL</span>
                  <span style="font-family:var(--mono); font-size:11px; color:rgba(245,245,255,.45)">wss://…</span>
                </label>
                <input type="text" id="livekitUrl" placeholder="wss://your-livekit-server.com" value="">
              </div>

              <div class="field">
                <label><span>Room Name</span></label>
                <input type="text" id="roomName" placeholder="interview-room" value="interview-demo">
              </div>

              <div class="field">
                <label><span>Access Token</span></label>
                <input type="text" id="accessToken" placeholder="Paste your LiveKit access token here">
              </div>

              <div class="row" style="margin-top:2px;">
                <button class="btn btn-primary" id="connectBtn" onclick="connectToRoom()">Connect</button>
                <button class="btn btn-danger" id="disconnectBtn" onclick="disconnectFromRoom()" disabled>Disconnect</button>
              </div>

              <div class="help" style="margin-top:6px;">
                <strong>Note:</strong> Token must allow join + publish/subscribe audio for the room.
              </div>
            </div>
          </div>
        </section>

        <section class="card">
          <div class="card-inner">
            <div class="card-title">
              <h2>Controls</h2>
              <span class="badge" id="controlsBadge">Idle</span>
            </div>

            <div class="status-grid">
              <div class="stat">
                <div class="k">Microphone</div>
                <div class="v" id="micStatusText">Not enabled</div>
              </div>
              <div class="stat">
                <div class="k">Speaker</div>
                <div class="v" id="speakerStatusText">Not enabled</div>
              </div>
            </div>

            <div class="row" style="margin-top: 12px;">
              <button class="btn btn-primary" id="toggleMicBtn" onclick="toggleMicrophone()" disabled>
                Enable Microphone
              </button>
            </div>

            <div class="stage-pill" style="margin-top: 12px;">
              <div>
                <div class="k">Current Stage</div>
                <div class="v" id="currentStage">Not Started</div>
              </div>
              <div class="badge" id="stageHint">Auto</div>
            </div>
          </div>
        </section>
      </aside>
    </main>

    <div class="toasts" id="toasts"></div>
  </div>

  <script>
    // ========= FIXES YOU ASKED FOR =========
    // 1) User speaking animation: LiveKit's setMicrophoneEnabled() does NOT reliably return a track.
    //    So we now: enable mic -> find the published mic track from localParticipant publications -> build analyser.
    // 2) Current Stage: now updates on Connected / AI joined and has a fallback stage timer.

    let room = null;
    let isMicEnabled = false;
    let isConnected = false;
    let LiveKitSDK = null;

    // Visualizers
    let audioCtx = null;
    let userAnalyser = null;
    let aiAnalyser = null;
    let aiElementSource = null;
    let rafId = null;
    let userLevel = 0;
    let aiLevel = 0;

    // Stage machine (simple UI-side)
    let aiJoined = false;
    let stageTimer = null;
    let stageTimeoutAIJoin = null;

    function escapeHtml(str){
      return (str ?? '').toString()
        .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
        .replaceAll('"','&quot;').replaceAll("'","&#039;");
    }

    function toast(message, type='info', ms=4500){
      const host = document.getElementById('toasts');
      const t = document.createElement('div');
      t.className = `toast ${type}`;
      const title = type === 'error' ? 'Error' : type === 'ok' ? 'Success' : 'Info';
      t.innerHTML = `
        <div class="top">
          <div>
            <div class="t">${title}</div>
            <div class="m">${escapeHtml(message)}</div>
          </div>
          <button class="x" aria-label="Close">×</button>
        </div>
      `;
      t.querySelector('.x').onclick = () => t.remove();
      host.appendChild(t);
      if (ms > 0) setTimeout(() => { if (t.isConnected) t.remove(); }, ms);
    }

    function waitForLiveKit() {
      return new Promise((resolve, reject) => {
        const possibleNames = ['LiveKitClient','LivekitClient','livekit','LiveKit'];
        function checkSDK() {
          for (const name of possibleNames) {
            const sdk = window[name];
            if (typeof sdk !== 'undefined' && sdk.Room) return sdk;
          }
          return null;
        }
        const sdk = checkSDK();
        if (sdk) return resolve(sdk);

        let attempts = 0;
        const maxAttempts = 100;
        const interval = setInterval(() => {
          attempts++;
          const found = checkSDK();
          if (found) { clearInterval(interval); resolve(found); }
          else if (attempts >= maxAttempts) { clearInterval(interval); reject(new Error('LiveKit SDK not found.')); }
        }, 100);
      });
    }

    function updateSDKStatus() {
      const ok = !!LiveKitSDK;
      document.getElementById('sdkStatus').textContent = ok ? 'SDK Loaded' : 'SDK Not Loaded';
      document.getElementById('hdrSdkDot').className = 'dot ' + (ok ? 'connected' : 'disconnected');
    }

    async function checkSDKStatus() {
      if (!LiveKitSDK) {
        try { LiveKitSDK = await waitForLiveKit(); toast('LiveKit SDK loaded.', 'ok', 2200); }
        catch(e){ toast('SDK load failed: ' + e.message, 'error', 7000); }
      } else {
        toast('SDK already loaded.', 'info', 1800);
      }
      updateSDKStatus();
    }

    window.addEventListener('load', async () => {
      try { LiveKitSDK = await waitForLiveKit(); } catch {}
      updateSDKStatus();
    });

    function updateConnectionStatus(status, text) {
      document.getElementById('hdrConnDot').className = `dot ${status}`;
      document.getElementById('hdrConnText').textContent = text;
      document.getElementById('connectionBadge').textContent = text;
      document.getElementById('connectionStatusText').textContent = text;
      document.getElementById('controlsBadge').textContent =
        status === 'connected' ? 'Live' : status === 'connecting' ? 'Connecting' : 'Idle';
    }

    function addMessage(sender, content, isSystem=false) {
      const messagesDiv = document.getElementById('messages');
      const msg = document.createElement('div');
      msg.className = `msg ${isSystem ? 'system' : sender}`;
      const timestamp = new Date().toLocaleTimeString();
      msg.innerHTML = `
        <div class="msg-head">
          <span><strong>${sender === 'system' ? 'System' : sender}</strong></span>
          <span>${timestamp}</span>
        </div>
        <div class="msg-body">${escapeHtml(content).replaceAll('\n','<br/>')}</div>
      `;
      messagesDiv.appendChild(msg);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    function addSystemMessage(content){ addMessage('system', content, true); }

    function updateStage(stageName){
      document.getElementById('currentStage').textContent = stageName;
    }

    // ---------- Audio analyzers ----------
    function ensureAudioContext() {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{});
      return audioCtx;
    }

    function createAnalyserFromMediaStreamTrack(mst) {
      const ctx = ensureAudioContext();
      const stream = new MediaStream([mst]);
      const source = ctx.createMediaStreamSource(stream);
      const analyser = ctx.createAnalyser();
      analyser.fftSize = 512;
      analyser.smoothingTimeConstant = 0.80;
      source.connect(analyser);
      return analyser;
    }

    function createAnalyserFromAudioElement(audioEl) {
      const ctx = ensureAudioContext();
      audioEl.muted = true; // avoid double-audio if routing via AudioContext
      aiElementSource = ctx.createMediaElementSource(audioEl);
      const analyser = ctx.createAnalyser();
      analyser.fftSize = 512;
      analyser.smoothingTimeConstant = 0.80;
      aiElementSource.connect(analyser);
      analyser.connect(ctx.destination);
      return analyser;
    }

    function rmsFromAnalyser(analyser) {
      if (!analyser) return 0;
      const buf = new Uint8Array(analyser.fftSize);
      analyser.getByteTimeDomainData(buf);
      let sum = 0;
      for (let i=0;i<buf.length;i++){
        const v = (buf[i] - 128) / 128;
        sum += v*v;
      }
      const rms = Math.sqrt(sum / buf.length);

      // slightly more sensitive for quieter mics
      return Math.min(1, Math.max(0, (rms - 0.004) * 7.0));
    }

    function startVisualLoop() {
      if (rafId) return;

      const userTile = document.getElementById('userTile');
      const aiTile = document.getElementById('aiTile');
      const userAvatar = document.getElementById('userAvatar');
      const aiAvatar = document.getElementById('aiAvatar');
      const userMeter = document.getElementById('userMeter');
      const aiMeter = document.getElementById('aiMeter');

      const tick = () => {
        const u = rmsFromAnalyser(userAnalyser);
        const a = rmsFromAnalyser(aiAnalyser);

        userLevel = userLevel * 0.80 + u * 0.20;
        aiLevel   = aiLevel   * 0.80 + a * 0.20;

        const uSpeak = userLevel > 0.06;
        const aSpeak = aiLevel > 0.08;

        userAvatar.style.setProperty('--level', userLevel.toFixed(3));
        aiAvatar.style.setProperty('--level', aiLevel.toFixed(3));
        userTile.style.setProperty('--lvl', userLevel.toFixed(3));
        aiTile.style.setProperty('--lvl', aiLevel.toFixed(3));

        userTile.classList.toggle('speaking', uSpeak && isMicEnabled && isConnected);
        aiTile.classList.toggle('speaking', aSpeak && isConnected);

        userMeter.textContent = `lvl ${userLevel.toFixed(2)}`;
        aiMeter.textContent = `lvl ${aiLevel.toFixed(2)}`;

        rafId = requestAnimationFrame(tick);
      };

      rafId = requestAnimationFrame(tick);
    }

    // ---------- Critical FIX: set user analyser from actual published mic track ----------
    async function setUserAnalyserFromPublishedMic(retries = 12, delayMs = 120) {
      if (!room || !LiveKitSDK) return false;

      const Track = LiveKitSDK.Track;
      const pubs = room.localParticipant?.audioTrackPublications;
      if (!pubs) return false;

      for (const pub of pubs.values()) {
        const src = pub.source;
        const isMic =
          src === Track.Source.Microphone ||
          src === Track.Source.Unknown || // some setups report Unknown
          pub.trackName?.toLowerCase?.().includes('microphone');

        if (isMic && pub.track && pub.track.mediaStreamTrack) {
          userAnalyser = createAnalyserFromMediaStreamTrack(pub.track.mediaStreamTrack);
          return true;
        }
      }

      if (retries > 0) {
        await new Promise(r => setTimeout(r, delayMs));
        return setUserAnalyserFromPublishedMic(retries - 1, delayMs);
      }
      return false;
    }

    function setMicStatusUI(active){
      document.getElementById('micStatus').textContent = active ? 'Active' : 'Not enabled';
      document.getElementById('micStatusText').textContent = active ? 'Active' : 'Not enabled';
    }
    function setSpeakerStatusUI(active){
      document.getElementById('speakerStatus').textContent = active ? 'Active' : 'Not enabled';
      document.getElementById('speakerStatusText').textContent = active ? 'Active' : 'Not enabled';
    }

    function updateMicButton() {
      const btn = document.getElementById('toggleMicBtn');
      if (isMicEnabled) {
        btn.textContent = 'Disable Microphone';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-danger');
      } else {
        btn.textContent = 'Enable Microphone';
        btn.classList.remove('btn-danger');
        btn.classList.add('btn-primary');
      }
    }

    // ---------- Stage logic (UI-side) ----------
    function resetStageMachine() {
      aiJoined = false;
      clearTimeout(stageTimer);
      clearTimeout(stageTimeoutAIJoin);
      stageTimer = null;
      stageTimeoutAIJoin = null;
      updateStage('Not Started');
    }

    function startStageMachineAfterConnect() {
      // immediate
      updateStage('Connected — waiting for AI');
      // if AI doesn’t join quickly, show a helpful stage
      stageTimeoutAIJoin = setTimeout(() => {
        if (!aiJoined && isConnected) updateStage('Waiting for AI (check agent dispatch/token)');
      }, 10000);
    }

    function onAIJoinedStageStart() {
      aiJoined = true;
      clearTimeout(stageTimeoutAIJoin);
      updateStage('Self Introduction');

      // fallback stage transition (demo-friendly)
      clearTimeout(stageTimer);
      stageTimer = setTimeout(() => {
        if (isConnected && aiJoined) updateStage('Past Experience');
      }, 120000); // 2 minutes
    }

    // ---------- LiveKit connect/disconnect ----------
    async function connectToRoom() {
      const url = document.getElementById('livekitUrl').value.trim();
      const roomName = document.getElementById('roomName').value.trim();
      const token = document.getElementById('accessToken').value.trim();

      if (!url || !roomName || !token) {
        toast('Please fill in LiveKit URL, Room Name, and Access Token.', 'error');
        return;
      }

      if (!LiveKitSDK) {
        try { LiveKitSDK = await waitForLiveKit(); }
        catch (e) { toast('LiveKit SDK not loaded. Refresh and try again.', 'error', 7000); return; }
        updateSDKStatus();
      }

      ensureAudioContext();   // user gesture -> ok
      startVisualLoop();

      const { Room, RoomEvent, RemoteParticipant } = LiveKitSDK;

      try {
        updateConnectionStatus('connecting', 'Connecting…');
        document.getElementById('connectBtn').disabled = true;

        resetStageMachine();

        room = new Room({ adaptiveStream: true, dynacast: true });

        // When local track is published, grab it for user analyzer (VERY RELIABLE)
        if (RoomEvent.LocalTrackPublished) {
          room.on(RoomEvent.LocalTrackPublished, async () => {
            await setUserAnalyserFromPublishedMic(20, 100);
          });
        }

        room.on(RoomEvent.Connected, () => {
          isConnected = true;
          updateConnectionStatus('connected', 'Connected');
          addSystemMessage('Successfully connected to interview room.');
          addSystemMessage('Waiting for AI interviewer to join…');
          document.getElementById('disconnectBtn').disabled = false;
          document.getElementById('toggleMicBtn').disabled = false;
          toast('Connected to LiveKit room.', 'ok', 2200);

          startStageMachineAfterConnect();
        });

        room.on(RoomEvent.Disconnected, () => {
          isConnected = false;
          updateConnectionStatus('disconnected', 'Disconnected');
          addSystemMessage('Disconnected from interview room.');
          document.getElementById('connectBtn').disabled = false;
          document.getElementById('disconnectBtn').disabled = true;
          document.getElementById('toggleMicBtn').disabled = true;
          isMicEnabled = false;
          updateMicButton();
          setMicStatusUI(false);
          setSpeakerStatusUI(false);
          userAnalyser = null;
          aiAnalyser = null;
          aiElementSource = null;
          resetStageMachine();
        });

        room.on(RoomEvent.ParticipantConnected, (participant) => {
          if (participant instanceof RemoteParticipant) {
            addSystemMessage('AI Interviewer joined the room.');
            onAIJoinedStageStart();
          }
        });

        room.on(RoomEvent.TrackSubscribed, (track) => {
          if (track.kind === 'audio') {
            const audioElement = track.attach();
            audioElement.autoplay = true;
            audioElement.play().catch(()=>{});

            setSpeakerStatusUI(true);
            addSystemMessage('AI interviewer audio connected.');

            // AI analyser (works well already)
            try {
              if (track.mediaStreamTrack) {
                aiAnalyser = createAnalyserFromMediaStreamTrack(track.mediaStreamTrack);
              } else if (audioElement.captureStream) {
                const s = audioElement.captureStream();
                const t = s.getAudioTracks()[0];
                if (t) aiAnalyser = createAnalyserFromMediaStreamTrack(t);
              } else {
                aiAnalyser = createAnalyserFromAudioElement(audioElement);
                audioElement.play().catch(()=>{});
              }
            } catch (e) {
              console.warn('AI analyser setup failed:', e);
              try { aiAnalyser = createAnalyserFromAudioElement(audioElement); } catch {}
            }
          }
        });

        room.on(RoomEvent.TrackUnsubscribed, (track) => {
          try { track.detach(); } catch {}
          if (track.kind === 'audio') {
            setSpeakerStatusUI(false);
            aiAnalyser = null;
            aiElementSource = null;
          }
        });

        await room.connect(url, token);
        await enableMicrophone();

      } catch (e) {
        console.error('Connection error:', e);
        toast(`Connection failed: ${e.message}`, 'error', 8000);
        updateConnectionStatus('disconnected', 'Connection Failed');
        document.getElementById('connectBtn').disabled = false;
        resetStageMachine();
      }
    }

    async function disconnectFromRoom() {
      try {
        if (room) { await room.disconnect(); room = null; }
      } catch (e) {
        console.warn('Disconnect error:', e);
      }
      isMicEnabled = false;
      updateMicButton();
      setMicStatusUI(false);
      userAnalyser = null;
      aiAnalyser = null;
      aiElementSource = null;
      resetStageMachine();
    }

    async function enableMicrophone() {
      try {
        if (!room || !isConnected) { toast('Not connected to room.', 'error'); return; }
        ensureAudioContext();

        // IMPORTANT: do NOT assign return value; it may be boolean/void in this SDK version
        await room.localParticipant.setMicrophoneEnabled(true);

        isMicEnabled = true;
        updateMicButton();
        setMicStatusUI(true);
        addSystemMessage('Microphone enabled — you can now speak.');

        // now reliably find the published mic track and build analyser
        const ok = await setUserAnalyserFromPublishedMic(25, 100);
        if (!ok) {
          toast('Mic enabled, but could not attach mic visualizer. (No published mic track found yet)', 'info', 3500);
        }
      } catch (e) {
        console.error('Microphone error:', e);
        toast(`Microphone error: ${e.message}`, 'error', 8000);
      }
    }

    async function disableMicrophone() {
      try {
        if (room?.localParticipant) {
          await room.localParticipant.setMicrophoneEnabled(false);
        }
        isMicEnabled = false;
        updateMicButton();
        setMicStatusUI(false);
        addSystemMessage('Microphone disabled.');
        userAnalyser = null;
      } catch (e) {
        console.error('Microphone error:', e);
        toast(`Microphone error: ${e.message}`, 'error', 8000);
      }
    }

    async function toggleMicrophone() {
      if (isMicEnabled) await disableMicrophone();
      else await enableMicrophone();
    }

    // Save / load URL + room
    window.addEventListener('DOMContentLoaded', () => {
      const savedUrl = localStorage.getItem('livekitUrl');
      const savedRoom = localStorage.getItem('roomName');
      if (savedUrl) document.getElementById('livekitUrl').value = savedUrl;
      if (savedRoom) document.getElementById('roomName').value = savedRoom;

      document.getElementById('livekitUrl').addEventListener('change', (e) => localStorage.setItem('livekitUrl', e.target.value));
      document.getElementById('roomName').addEventListener('change', (e) => localStorage.setItem('roomName', e.target.value));
    });

    // Initial UI state
    updateConnectionStatus('disconnected', 'Disconnected');
    setMicStatusUI(false);
    setSpeakerStatusUI(false);
    resetStageMachine();
  </script>
</body>
</html>
